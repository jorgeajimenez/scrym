<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formation Logic Tester</title>
    <style>
        :root { --bg: #0f172a; --text: #f8fafc; --field: #1e293b; --accent: #3b82f6; }
        body { background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        .container { background: #111827; padding: 20px; border-radius: 12px; border: 1px solid #374151; width: 600px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .field { display: flex; flex-direction: column; gap: 5px; }
        label { font-size: 12px; font-weight: bold; color: #9ca3af; text-transform: uppercase; }
        input, select { padding: 10px; border-radius: 6px; border: 1px solid #4b5563; background: #1f2937; color: white; font-size: 14px; }
        
        button { grid-column: span 2; padding: 12px; background: var(--accent); color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        button:hover { background: #2563eb; }

        canvas { background: var(--field); border: 2px solid #334155; border-radius: 8px; margin-top: 20px; width: 100%; height: 300px; }
        .formation-label { margin-top: 10px; font-size: 18px; font-weight: 900; color: var(--accent); }
        .curl-hint { margin-top: 20px; font-family: monospace; font-size: 11px; color: #6b7280; background: #000; padding: 10px; border-radius: 4px; width: 100%; box-sizing: border-box; }
    </style>
</head>
<body>

    <div class="container">
        <div class="header">
            <h3>♟️ Formation Logic Tester (v2)</h3>
            <select id="scenarioSelect" onchange="loadScenario()">
                <option value="">-- Select Scenario --</option>
                <option value='{"play_type":"pass", "personnel":"11", "ydstogo":4, "is_2min":0}'>3rd & 4 (Bunch Logic)</option>
                <option value='{"play_type":"pass", "personnel":"11", "ydstogo":10, "is_2min":0}'>3rd & 10 (Spread Logic)</option>
                <option value='{"play_type":"run", "personnel":"21", "ydstogo":5, "is_2min":0}'>1st & 10 (Pistol Logic)</option>
                <option value='{"play_type":"run", "personnel":"22", "ydstogo":1, "is_2min":0}'>Goal Line (Jumbo Logic)</option>
                <option value='{"play_type":"pass", "personnel":"10", "ydstogo":15, "is_2min":1}'>2-Min Drill (Empty Set)</option>
            </select>
        </div>

        <div class="form-grid">
            <div class="field">
                <label>Play Type</label>
                <select id="play_type">
                    <option value="pass">PASS</option>
                    <option value="run">RUN</option>
                </select>
            </div>
            <div class="field">
                <label>Personnel</label>
                <input type="text" id="personnel" value="11" placeholder="e.g. 11, 12, 21, 22">
            </div>
            <div class="field">
                <label>Yards to Go</label>
                <input type="number" id="ydstogo" value="10">
            </div>
            <div class="field">
                <label>Clock Mode</label>
                <select id="is_2min">
                    <option value="0">Normal</option>
                    <option value="1">2-Minute Drill</option>
                </select>
            </div>
            <button onclick="processAndDraw()">LOAD & DRAW FORMATION</button>
        </div>

        <div class="formation-label" id="formationDisplay">SELECT A SCENARIO</div>
        <canvas id="fieldCanvas" width="600" height="300"></canvas>
        
        <div class="curl-hint" id="curlPreview">
            curl -X POST "http://localhost:8000/predict/formation" ...
        </div>
    </div>

    <script>
        // Mapped from backend/formation_logic.py
        const TEMPLATES = {
            "Shotgun Spread": [{r:"C",x:0,y:0},{r:"QB",x:0,y:-5},{r:"RB",x:1.5,y:-5},{r:"WR",x:-20,y:0},{r:"WR",x:20,y:0},{r:"WR",x:-15,y:0},{r:"TE",x:4.5,y:0},{r:"LT",x:-3,y:0},{r:"RT",x:3,y:0},{r:"LG",x:-1.5,y:0},{r:"RG",x:1.5,y:0}],
            "Gun Bunch Right": [{r:"C",x:0,y:0},{r:"QB",x:0,y:-5},{r:"RB",x:-1.5,y:-5},{r:"WR",x:-20,y:0},{r:"WR",x:12,y:0},{r:"WR",x:14,y:-1},{r:"TE",x:10,y:-1},{r:"LT",x:-3,y:0},{r:"RT",x:3,y:0},{r:"LG",x:-1.5,y:0},{r:"RG",x:1.5,y:0}],
            "I-Formation": [{r:"C",x:0,y:0},{r:"QB",x:0,y:-1},{r:"FB",x:0,y:-4},{r:"RB",x:0,y:-7},{r:"WR",x:-20,y:0},{r:"WR",x:20,y:0},{r:"TE",x:4.5,y:0},{r:"LT",x:-3,y:0},{r:"RT",x:3,y:0},{r:"LG",x:-1.5,y:0},{r:"RG",x:1.5,y:0}],
            "Pistol Strong": [{r:"C",x:0,y:0},{r:"QB",x:0,y:-4},{r:"RB",x:0,y:-7},{r:"TE",x:4.5,y:0},{r:"TE",x:-4.5,y:-1},{r:"WR",x:-20,y:0},{r:"WR",x:20,y:0},{r:"LT",x:-3,y:0},{r:"RT",x:3,y:0},{r:"LG",x:-1.5,y:0},{r:"RG",x:1.5,y:0}],
            "Empty Set": [{r:"C",x:0,y:0},{r:"QB",x:0,y:-5},{r:"WR",x:-22,y:0},{r:"WR",x:-16,y:0},{r:"WR",x:22,y:0},{r:"WR",x:16,y:0},{r:"WR",x:10,y:0},{r:"LT",x:-3,y:0},{r:"RT",x:3,y:0},{r:"LG",x:-1.5,y:0},{r:"RG",x:1.5,y:0}],
            "Singleback Ace": [{r:"C",x:0,y:0},{r:"QB",x:0,y:-1},{r:"RB",x:0,y:-6},{r:"WR",x:-20,y:0},{r:"WR",x:20,y:0},{r:"TE",x:-4.5,y:0},{r:"TE",x:4.5,y:0},{r:"LT",x:-3,y:0},{r:"RT",x:3,y:0},{r:"LG",x:-1.5,y:0},{r:"RG",x:1.5,y:0}],
            "Goal Line Jumbo": [{r:"C",x:0,y:0},{r:"QB",x:0,y:-1},{r:"FB",x:0,y:-3},{r:"RB",x:0,y:-6},{r:"TE",x:-4.5,y:0},{r:"TE",x:4.5,y:0},{r:"TE",x:6,y:0},{r:"LT",x:-3,y:0},{r:"RT",x:3,y:0},{r:"LG",x:-1.5,y:0},{r:"RG",x:1.5,y:0}]
        };

        function loadScenario() {
            const val = document.getElementById('scenarioSelect').value;
            if (!val) return;
            const data = JSON.parse(val);
            document.getElementById('play_type').value = data.play_type;
            document.getElementById('personnel').value = data.personnel;
            document.getElementById('ydstogo').value = data.ydstogo;
            document.getElementById('is_2min').value = data.is_2min;
            processAndDraw();
        }

        function processAndDraw() {
            const play = document.getElementById('play_type').value;
            const pers = document.getElementById('personnel').value;
            const togo = parseInt(document.getElementById('ydstogo').value);
            const is2m = parseInt(document.getElementById('is_2min').value);

            // INTELLIGENT LOGIC (Mirrors backend/formation_logic.py)
            let name = "Singleback Ace";
            
            if (is2m === 1) {
                name = "Empty Set";
            } else if (togo <= 1 && ["22","23","13"].includes(pers)) {
                name = "Goal Line Jumbo";
            } else if (play === "run") {
                if (["21","22","13"].includes(pers)) {
                    // Short = Power, Med = Pistol
                    name = (togo < 3) ? "I-Formation" : "Pistol Strong";
                } else {
                    name = "Singleback Ace";
                }
            } else {
                // Pass Logic
                if (togo >= 10) name = "Empty Set";
                else if (togo > 6) name = "Shotgun Spread";
                else if (togo >= 3) name = "Gun Bunch Right"; // Creating rub routes
                else name = "Singleback Ace";
            }

            document.getElementById('formationDisplay').textContent = name.toUpperCase();
            
            // Update CURL preview
            document.getElementById('curlPreview').textContent = `curl -X POST "http://localhost:8000/predict/formation" -H "Content-Type: application/json" -d '{"play_type":"${play}", "personnel":"${pers}", "ydstogo":${togo}, "is_2min":${is2m}}'`;

            draw(TEMPLATES[name]);
        }

        function draw(players) {
            const canvas = document.getElementById('fieldCanvas');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0,0,600,300);
            
            // Line of Scrimmage
            ctx.strokeStyle = "rgba(255,255,255,0.1)";
            ctx.beginPath(); ctx.moveTo(0,150); ctx.lineTo(600,150); ctx.stroke();

            // Hash marks
            ctx.fillStyle = "rgba(255,255,255,0.2)";
            ctx.fillRect(200, 148, 4, 4);
            ctx.fillRect(400, 148, 4, 4);

            players.forEach(p => {
                const x = 300 + (p.x * 12);
                const y = 150 - (p.y * 12);
                ctx.fillStyle = "#3b82f6";
                ctx.beginPath(); ctx.arc(x, y, 10, 0, Math.PI*2); ctx.fill();
                ctx.fillStyle = "white";
                ctx.font = "bold 9px Inter"; ctx.textAlign="center";
                ctx.fillText(p.r, x, y+3);
            });
        }
    </script>
</body>
</html>
